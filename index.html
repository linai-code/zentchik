<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ó–∞–ø–∏—Å–∏ + –†–∞—Å—Å—ã–ª–∫–∞</title>
<style>
  :root{
    --bg:#f6f8ff;
    --text:#00003c;
    --muted:#99a1c2;
    --brand:#0061ff;
    --brand-2:#00e4ca;
    --card:#ffffff;
    --bd:#ccdfff;
    --shadow:0 4px 12px rgba(0,97,255,.1);
    --radius:12px;
  }
  body{margin:0;background:var(--bg);color:var(--text);font-family:"IBM Plex Sans",system-ui,sans-serif;padding:1rem;display:flex;justify-content:center;}
  .container{max-width:900px;width:100%;display:flex;flex-direction:column;gap:1rem;}
  h2{margin:0 0 0.5rem;font-weight:600;font-size:1.1rem;}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem;}
  input, select{width:100%;padding:0.4rem 0.5rem;border:1px solid var(--bd);border-radius:10px;margin-bottom:0.5rem;font-size:0.9rem;outline:none;}
  input:focus, select:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--brand-2);}
  button{display:inline-block;padding:0.4rem 0.75rem;border-radius:10px;border:1px solid var(--bd);background:var(--brand);color:#fff;font-weight:500;cursor:pointer;transition:all 0.15s;}
  button:hover{background:#004bd1;}
  button:disabled{opacity:.6;cursor:not-allowed;}
  .post{border:1px solid var(--bd);border-radius:var(--radius);padding:0.5rem;margin-top:0.5rem;background:#fafcff;display:flex;justify-content:space-between;align-items:center;gap:0.5rem;}
  .post strong{display:block;margin-bottom:0.25rem;}
  .editor-toolbar{display:flex;gap:0.5rem;margin-bottom:0.5rem;}
  .editor-toolbar button{background:#fff;color:var(--text);border:1px solid var(--bd);}
  .editor{min-height:120px;padding:0.6rem 0.75rem;border:1px solid var(--bd);border-radius:10px;background:#fff;outline:none;}
  @media (max-width:600px){body{padding:0.5rem;}.editor{min-height:100px;}}
</style>
<script>
const OWNER = 'linai-code';
const REPO = 'zentchik';

let TOKEN = sessionStorage.getItem('gh_token');
if (!TOKEN) {
  TOKEN = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à GitHub Personal Access Token:');
  sessionStorage.setItem('gh_token', TOKEN);
}

const HEADERS = {
  'Authorization': `Bearer ${TOKEN}`,
  'Accept': 'application/vnd.github.raw+json',
  'X-GitHub-Api-Version': '2022-11-28',
  'User-Agent': 'linai'
};

async function loadFileFromGitHub(filePath) {
  try {
    const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`, { headers: HEADERS });
    if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filePath}: ${res.status}`);
    return await res.json();
  } catch (err) {
    console.error(err);
    return [];
  }
}

async function saveToGitHub(filePath, content, message) {
  const getRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`, { headers: HEADERS });
  const fileData = await getRes.json();
  const sha = fileData.sha;

  const putRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`, {
    method: 'PUT',
    headers: {
      ...HEADERS,
      'Accept': 'application/vnd.github+json'
    },
    body: JSON.stringify({ message, content: btoa(unescape(encodeURIComponent(content))), sha })
  });

  if (!putRes.ok) {
    const err = await putRes.json();
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + err.message);
  }
}

function ensureArray(data) {
  return Array.isArray(data) ? data : (data ? Object.values(data) : []);
}

let posts = [];
let channels = [];

async function loadPosts() {
  posts = ensureArray(await loadFileFromGitHub("posts.json"));
  renderPosts();
}

async function loadChannels() {
  channels = ensureArray(await loadFileFromGitHub("channels.json"));
  renderChannels();
}

async function savePosts() { await saveToGitHub('posts.json', JSON.stringify(posts, null, 2), 'update posts'); }
async function saveChannels() { await saveToGitHub('channels.json', JSON.stringify(channels, null, 2), 'update channels'); }

function renderPosts() {
  const list = document.getElementById('list');
  const selectPost = document.getElementById('selectPost');
  list.innerHTML = '';
  selectPost.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å</option>';
  posts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `<div><strong>${p.title}</strong><div>${p.content}</div></div>`;
    const delBtn = document.createElement('button');
    delBtn.textContent = 'üóë';
    delBtn.onclick = () => deletePost(p.id);
    div.appendChild(delBtn);
    list.appendChild(div);
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.title;
    selectPost.appendChild(opt);
  });
}

function renderChannels() {
  const channelsList = document.getElementById('channels');
  const selectChannel = document.getElementById('selectChannel');
  channelsList.innerHTML = '';
  selectChannel.innerHTML = '';
  channels.forEach(c => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `<div><strong>${c.id}</strong></div>`;
    const delBtn = document.createElement('button');
    delBtn.textContent = 'üóë';
    delBtn.onclick = () => deleteChannel(c.id);
    div.appendChild(delBtn);
    channelsList.appendChild(div);
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.id;
    selectChannel.appendChild(opt);
  });
}

async function deletePost(id) { posts = posts.filter(p => p.id !== id); await savePosts(); renderPosts(); }
async function deleteChannel(id) { channels = channels.filter(c => c.id !== id); await saveChannels(); renderChannels(); }

function formatText(command) { document.execCommand(command, false, null); }
function insertLink() {
  const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL');
  if (url) {
    let selection = window.getSelection();
    if (!selection.rangeCount) return;
    let range = selection.getRangeAt(0);
    if (selection.toString().length === 0) {
      const linkText = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏') || url;
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = linkText;
      range.insertNode(a);
    } else {
      document.execCommand('createLink', false, url);
      document.querySelectorAll('a').forEach(a => {
        if (a.href === url || a.href === url + '/') {
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
        }
      });
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadPosts();
  loadChannels();

  document.getElementById('createBtn').onclick = async () => {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').innerHTML.trim();
    if (!title || !content) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç');
    const id = crypto.randomUUID();
    posts.unshift({ id, title, content, createdAt: Date.now() });
    await savePosts();
    renderPosts();
    document.getElementById('title').value = '';
    document.getElementById('content').innerHTML = '';
  };

  document.getElementById('addChannelBtn').onclick = async () => {
    const id = document.getElementById('channelId').value.trim();
    if (!id) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞');
    channels.push({ id });
    await saveChannels();
    renderChannels();
    document.getElementById('channelId').value = '';
  };

  document.getElementById('sendBtn').onclick = async () => {
    const postId = document.getElementById('selectPost').value;
    const selectedOptions = Array.from(document.getElementById('selectChannel').selectedOptions).map(o => o.value);
    if (!postId || selectedOptions.length === 0) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–∞–Ω–∞–ª');
    const payload = { status: true, postId, channels: selectedOptions, timestamp: new Date().toISOString() };
    await saveToGitHub('send.json', JSON.stringify(payload, null, 2), 'send post');
    alert('–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
  };
});
</script>
</head>
<body>
<div class="container">
  <div class="card">
    <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
    <input id="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" />
    <div class="editor-toolbar">
      <button type="button" onclick="formatText('bold')"><b>B</b></button>
      <button type="button" onclick="insertLink()">üîó</button>
    </div>
    <div id="content" class="editor" contenteditable="true"></div>
    <button id="createBtn">–°–æ–∑–¥–∞—Ç—å</button>
  </div>
  <div class="card">
    <h2>–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π</h2>
    <div id="list"></div>
  </div>
  <div class="card">
    <h2>–ö–∞–Ω–∞–ª—ã</h2>
    <input id="channelId" placeholder="ID –∫–∞–Ω–∞–ª–∞" />
    <button id="addChannelBtn">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª</button>
    <div id="channels"></div>
  </div>
  <div class="card">
    <h2>–†–∞—Å—Å—ã–ª–∫–∞</h2>
    <select id="selectPost"></select>
    <select id="selectChannel" multiple size="5"></select>
    <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>
</body>
</html>
