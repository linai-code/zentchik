<script>
const OWNER = 'linai-code';
const REPO = 'zentchik';

let TOKEN = sessionStorage.getItem('github_token') || null;
if (!TOKEN) {
  TOKEN = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à GitHub Personal Access Token:");
  if (!TOKEN) {
    alert("–¢–æ–∫–µ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.");
    throw new Error("–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞");
  }
  sessionStorage.setItem('github_token', TOKEN);
}

const HEADERS = {
  'Authorization': `Bearer ${TOKEN}`,
  'Accept': 'application/vnd.github+json',
  'X-GitHub-Api-Version': '2022-11-28',
  'User-Agent': 'linai'
};

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
async function loadFileFromGitHub(filePath) {
  try {
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`,
      { headers: { ...HEADERS, Accept: 'application/vnd.github.raw' } }
    );
    if (res.status === 404) return [];
    if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${filePath}: ${res.status}`);
    const text = await res.text();
    try {
      return JSON.parse(text);
    } catch {
      return [];
    }
  } catch (err) {
    console.error(err);
    return [];
  }
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
async function saveToGitHub(filePath, content, message) {
  let sha;
  try {
    const getRes = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`,
      { headers: { ...HEADERS, Accept: 'application/vnd.github+json' } }
    );
    if (getRes.ok) {
      const fileData = await getRes.json();
      sha = fileData.sha;
    }
  } catch {}

  const putBody = {
    message,
    content: btoa(unescape(encodeURIComponent(content)))
  };
  if (sha) putBody.sha = sha;

  const putRes = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`,
    {
      method: 'PUT',
      headers: { ...HEADERS, Accept: 'application/vnd.github+json' },
      body: JSON.stringify(putBody)
    }
  );

  if (!putRes.ok) {
    const err = await putRes.json();
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + err.message);
  }
}

function ensureArray(data) {
  if (Array.isArray(data)) return data;
  if (!data) return [];
  return Object.values(data);
}

let posts = [];
let channels = [];

async function loadPosts() {
  posts = ensureArray(await loadFileFromGitHub('posts.json'));
  renderPosts();
}

async function loadChannels() {
  channels = ensureArray(await loadFileFromGitHub('channels.json'));
  renderChannels();
}

async function savePosts() {
  await saveToGitHub('posts.json', JSON.stringify(posts, null, 2), 'update posts');
}
async function saveChannels() {
  await saveToGitHub('channels.json', JSON.stringify(channels, null, 2), 'update channels');
}

function renderPosts() {
  const list = document.getElementById('list');
  const selectPost = document.getElementById('selectPost');
  list.innerHTML = '';
  selectPost.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å</option>';
  posts.forEach(p => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `<div><strong>${p.title}</strong><div>${p.content}</div></div>`;
    const delBtn = document.createElement('button');
    delBtn.textContent = 'üóë';
    delBtn.onclick = () => deletePost(p.id);
    div.appendChild(delBtn);
    list.appendChild(div);
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = p.title;
    selectPost.appendChild(opt);
  });
}

function renderChannels() {
  const channelsList = document.getElementById('channels');
  const selectChannel = document.getElementById('selectChannel');
  channelsList.innerHTML = '';
  selectChannel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–Ω–∞–ª</option>';
  channels.forEach(c => {
    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `<div><strong>${c.id}</strong></div>`;
    const delBtn = document.createElement('button');
    delBtn.textContent = 'üóë';
    delBtn.onclick = () => deleteChannel(c.id);
    div.appendChild(delBtn);
    channelsList.appendChild(div);
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.id;
    selectChannel.appendChild(opt);
  });
}

async function deletePost(id) {
  posts = posts.filter(p => p.id !== id);
  await savePosts();
  renderPosts();
}
async function deleteChannel(id) {
  channels = channels.filter(c => c.id !== id);
  await saveChannels();
  renderChannels();
}

function formatText(command) { document.execCommand(command, false, null); }
function insertLink() {
  const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL');
  if (url) {
    let selection = window.getSelection();
    if (!selection.rangeCount) return;
    let range = selection.getRangeAt(0);
    if (selection.toString().length === 0) {
      const linkText = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏') || url;
      const a = document.createElement('a');
      a.href = url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = linkText;
      range.insertNode(a);
    } else {
      document.execCommand('createLink', false, url);
      document.querySelectorAll('a').forEach(a => {
        if (a.href === url || a.href === url + '/') {
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
        }
      });
    }
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadPosts();
  loadChannels();

  document.getElementById('createBtn').onclick = async () => {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').innerHTML.trim();
    if (!title || !content) return alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç');
    const id = crypto.randomUUID();
    posts.unshift({ id, title, content, createdAt: Date.now() });
    await savePosts();
    renderPosts();
    document.getElementById('title').value = '';
    document.getElementById('content').innerHTML = '';
  };

  document.getElementById('addChannelBtn').onclick = async () => {
    const id = document.getElementById('channelId').value.trim();
    if (!id) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞');
    channels.push({ id });
    await saveChannels();
    renderChannels();
    document.getElementById('channelId').value = '';
  };

  document.getElementById('sendBtn').onclick = async () => {
    const postId = document.getElementById('selectPost').value;
    const channelId = document.getElementById('selectChannel').value;
    if (!postId || !channelId) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø–∏—Å—å –∏ –∫–∞–Ω–∞–ª');
    const payload = { status: true, postId, channelId, timestamp: new Date().toISOString() };
    await saveToGitHub('send.json', JSON.stringify(payload, null, 2), 'send post');
    alert('–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
  };
});
</script>
